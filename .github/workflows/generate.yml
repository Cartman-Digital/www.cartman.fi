name: Generate site

on:
  repository_dispatch:
    types: [publish-event]
  workflow_dispatch:

jobs:
  generate:
    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'read'
    runs-on: ubuntu-latest
    # container:
    #   image: ghcr.io/cartman-digital/www.cartman.fi:main
    #   options: --cpus 1
    #   env:
    #     CONTENTFUL_ENVIRONMENT: "${{ vars.CONTENTFUL_ENVIRONMENT }}"
    #     CONTENTFUL_SPACE: "${{ vars.CONTENTFUL_SPACE }}"
    #     CONTENTFUL_TOKEN: "${{ secrets.CONTENTFUL_TOKEN }}"
    #     BASE_URL: "${{ vars.BASE_URL }}"
    steps:
      - name: Install
        run: echo '<?xml version="1.0" encoding="UTF-8"?><project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"><dependency><groupId>com.github.Cartman-Digital</groupId><artifactId>www.cartman.fi</artifactId><version>0.0.1-SNAPSHOT</version></dependency></project>' > pom.xml && mvn install

      - name: Generate
        run: ls -al

      - name: Generate
        run: java -jar /app/generator-standalone.jar -generate
        env:
          CONTENTFUL_ENVIRONMENT: "${{ vars.CONTENTFUL_ENVIRONMENT }}"
          CONTENTFUL_SPACE: "${{ vars.CONTENTFUL_SPACE }}"
          CONTENTFUL_TOKEN: "${{ secrets.CONTENTFUL_TOKEN }}"
          BASE_URL: "${{ vars.BASE_URL }}"

      - id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: 'projects/43005639550/locations/global/workloadIdentityPools/github/providers/github'
          service_account: 'github-uploader@www-cartman-fi.iam.gserviceaccount.com'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
        with:
          version: '>= 416.0.0'

      - name: Upload
        run: gsutil -m rsync -d -r build gs://www-cartman-fi-prod
